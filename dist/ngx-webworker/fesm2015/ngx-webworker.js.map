{"version":3,"file":"ngx-webworker.js","sources":["ng://ngx-webworker/lib/webworker.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\n\ntype CallbackFunction = () => void;\n\n@Injectable()\nexport class WebworkerService {\n  private workerFunctionToUrlMap = new WeakMap<CallbackFunction, string>();\n  private promiseToWorkerMap = new WeakMap<Promise<any>, Worker>();\n\n  run<T>(workerFunction: (input: any) => T, data?: any): Promise<T> {\n    const url = this.getOrCreateWorkerUrl(workerFunction);\n    return this.runUrl(url, data);\n  }\n\n  runUrl(url: string, data?: any): Promise<any> {\n    const worker = new Worker(url);\n    const promise = this.createPromiseForWorker(worker, data);\n    const promiseCleaner = this.createPromiseCleaner(promise);\n\n    this.promiseToWorkerMap.set(promise, worker);\n\n    promise.then(promiseCleaner).catch(promiseCleaner);\n\n    return promise;\n  }\n\n  terminate<T>(promise: Promise<T>): Promise<T> {\n    return this.removePromise(promise);\n  }\n\n  getWorker(promise: Promise<any>): Worker {\n    return this.promiseToWorkerMap.get(promise);\n  }\n\n  private createPromiseForWorker<T>(worker: Worker, data: any) {\n    return new Promise<T>((resolve, reject) => {\n      worker.addEventListener('message', (event) => resolve(event.data));\n      worker.addEventListener('error', reject);\n      worker.postMessage(data);\n    });\n  }\n\n  private getOrCreateWorkerUrl(fn: any): string {\n    if (!this.workerFunctionToUrlMap.has(fn)) {\n      const url = this.createWorkerUrl(fn);\n      this.workerFunctionToUrlMap.set(fn, url);\n      return url;\n    }\n    return this.workerFunctionToUrlMap.get(fn);\n  }\n\n  private createWorkerUrl(resolve: CallbackFunction): string {\n    const resolveString = resolve.toString();\n    const webWorkerTemplate = `\n      self.addEventListener('message', function(e) {\n        postMessage((${resolveString})(e.data));\n      });\n    `;\n    const blob = new Blob([webWorkerTemplate], { type: 'text/javascript' });\n    return URL.createObjectURL(blob);\n  }\n\n  private createPromiseCleaner<T>(promise: Promise<T>): (input: any) => T {\n    return (event) => {\n      this.removePromise(promise);\n      return event;\n    };\n  }\n\n  private removePromise<T>(promise: Promise<T>): Promise<T> {\n    const worker = this.promiseToWorkerMap.get(promise);\n    if (worker) {\n      worker.terminate();\n    }\n    this.promiseToWorkerMap.delete(promise);\n    return promise;\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA,MAKa,gBAAgB;IAD7B;QAEU,2BAAsB,GAAG,IAAI,OAAO,EAA4B,CAAC;QACjE,uBAAkB,GAAG,IAAI,OAAO,EAAwB,CAAC;KAsElE;;;;;;;IApEC,GAAG,CAAI,cAAiC,EAAE,IAAU;;cAC5C,GAAG,GAAG,IAAI,CAAC,oBAAoB,CAAC,cAAc,CAAC;QACrD,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;KAC/B;;;;;;IAED,MAAM,CAAC,GAAW,EAAE,IAAU;;cACtB,MAAM,GAAG,IAAI,MAAM,CAAC,GAAG,CAAC;;cACxB,OAAO,GAAG,IAAI,CAAC,sBAAsB,CAAC,MAAM,EAAE,IAAI,CAAC;;cACnD,cAAc,GAAG,IAAI,CAAC,oBAAoB,CAAC,OAAO,CAAC;QAEzD,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;QAE7C,OAAO,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,KAAK,CAAC,cAAc,CAAC,CAAC;QAEnD,OAAO,OAAO,CAAC;KAChB;;;;;;IAED,SAAS,CAAI,OAAmB;QAC9B,OAAO,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;KACpC;;;;;IAED,SAAS,CAAC,OAAqB;QAC7B,OAAO,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;KAC7C;;;;;;;;IAEO,sBAAsB,CAAI,MAAc,EAAE,IAAS;QACzD,OAAO,IAAI,OAAO;;;;;QAAI,CAAC,OAAO,EAAE,MAAM;YACpC,MAAM,CAAC,gBAAgB,CAAC,SAAS;;;;YAAE,CAAC,KAAK,KAAK,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,EAAC,CAAC;YACnE,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;YACzC,MAAM,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;SAC1B,EAAC,CAAC;KACJ;;;;;;IAEO,oBAAoB,CAAC,EAAO;QAClC,IAAI,CAAC,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE;;kBAClC,GAAG,GAAG,IAAI,CAAC,eAAe,CAAC,EAAE,CAAC;YACpC,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,EAAE,EAAE,GAAG,CAAC,CAAC;YACzC,OAAO,GAAG,CAAC;SACZ;QACD,OAAO,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;KAC5C;;;;;;IAEO,eAAe,CAAC,OAAyB;;cACzC,aAAa,GAAG,OAAO,CAAC,QAAQ,EAAE;;cAClC,iBAAiB,GAAG;;uBAEP,aAAa;;KAE/B;;cACK,IAAI,GAAG,IAAI,IAAI,CAAC,CAAC,iBAAiB,CAAC,EAAE,EAAE,IAAI,EAAE,iBAAiB,EAAE,CAAC;QACvE,OAAO,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;KAClC;;;;;;;IAEO,oBAAoB,CAAI,OAAmB;QACjD;;;;QAAO,CAAC,KAAK;YACX,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;YAC5B,OAAO,KAAK,CAAC;SACd,EAAC;KACH;;;;;;;IAEO,aAAa,CAAI,OAAmB;;cACpC,MAAM,GAAG,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,OAAO,CAAC;QACnD,IAAI,MAAM,EAAE;YACV,MAAM,CAAC,SAAS,EAAE,CAAC;SACpB;QACD,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;QACxC,OAAO,OAAO,CAAC;KAChB;;;YAxEF,UAAU;;;;;"}